<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments :: page_head(${pageTitle})" />

<body>
<div class="container-fluid">

    <div th:replace="navigation :: menu"></div>

    <div>
        <h2>Manage Users | [[${pageTitle}]]</h2>
    </div>

    <!--
        在save form之前对邮箱地址进行检查 onsubmit="return checkEmailUnique(this)"

        enctype="multipart/form-data" -> This allows file upload for the form
    -->
    <form enctype="multipart/form-data" method="post" onsubmit="return checkEmailUnique(this)"
          style="max-width: 700px; margin: 0 auto"
          th:action="@{/users/save}" th:object="${user}">
        <input th:field="*{id}" type="hidden"/>
        <div class="border border-secondary rounded p-3">
            <div class="form-group row">
                <label class="col-sm-4 col-form-label">E-mail:</label>
                <div class="col-sm-8">
                    <input class="form-control" maxlength="128" minlength="8" required th:field="*{email}"
                           type="email"/>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-4 col-form-label">First Name:</label>
                <div class="col-sm-8">
                    <input class="form-control" maxlength="45" minlength="2" required th:field="*{firstName}"
                           type="text"/>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-4 col-form-label">Last Name:</label>
                <div class="col-sm-8">
                    <input class="form-control" maxlength="45" minlength="2" required th:field="*{lastName}"
                           type="text"/>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-4 col-form-label">Password:</label>
                <div class="col-sm-8">
                    <input class="form-control" maxlength="20" minlength="8"
                           required th:field="*{password}" th:if="${user.id == null}" type="password"/>
                    <input class="form-control" maxlength="20" minlength="8"
                           th:field="*{password}" th:if="${user.id != null}" type="password"/>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-4 col-form-label">Roles:</label>
                <div class="col-sm-8">
                    <th:block th:each="role : ${listRoles}">
                        <input class="m-2" th:field="*{roles}"
                               th:text="${role.name}"
                               th:value="${role.id}"
                               type="checkbox"
                        />
                        - <small>[[${role.description}]]</small>
                        <br/>
                    </th:block>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-4 col-form-label">Enabled:</label>
                <div class="col-sm-8">
                    <input th:field="*{enabled}" type="checkbox"/>
                </div>
            </div>

            <!--update the image-->
            <div class="form-group row">
                <label class="col-sm-4 col-form-label">Photos:</label>
                <div class="col-sm-8">
                    <!--
                        It is used to pass data to the server when the form is submitted.
                        The data is in the value attribute. As it is hidden the user can't see it, but the Server gets extra information about the form.


                        That hidden field is needed in case editing user.
                        The photos name will be in the form and won't get lost when the user's details are saved (if no change to existing photo).
                    -->
                    <input th:field="*{photos}" type="hidden"/>
                    <!-- class="mb-2" set the preview pic size-->
                    <input accept="image/png, image/jpeg" class="mb-2" id="fileImage" name="image"
                           type="file"/>
                    <!--show an image-->
                    <img alt="Photos preview" class="img-fluid" id="thumbnail"
                         th:src="@{${user.photosImagePath}}"/>
                </div>
            </div>


            <div class="text-center">
                <input class="btn btn-primary m-3" type="submit" value="Save"/>
                <input class="btn btn-secondary" id="buttonCancel" type="button" value="Cancel"/>
            </div>

        </div>
    </form>

    <!--弹窗-->
    <div class="modal fade text-center" id="modalDialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="modalTitle"></h4>
                    <button class="close" data-dismiss="modal" type="button">&times;</button>
                </div>

                <div class="modal-body">
                    <span id="modalBody"></span>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-danger" data-dismiss="modal" type="button">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="fragments :: footer"></div>

</div>

<!--编写js-->
<script type="text/javascript">
    <!--
    id = "buttonCancel"
    链接起来
    $("#buttonCancel") -->
    $(document).ready(function () {
        $("#buttonCancel").on("click", function () {
            window.location = "[[@{/users}]]";
        });

        $("#fileImage").change(function () {
            fileSize = this.files[0].size;

            if (fileSize > 10485760) {
                this.setCustomValidity("You must choose an image less than 10MB!");
                this.reportValidity();
            } else {
                // this.setCustomValidity("here");
                showImageThumbnail(this);
            }

        });
    });

    function showImageThumbnail(fileInput) {
        var file = fileInput.files[0];
        var reader = new FileReader();
        reader.onload = function (e) {
            $("#thumbnail").attr("src", e.target.result);
        };

        reader.readAsDataURL(file);
    }

    function checkEmailUnique(form) {
        url = "[[@{/users/check_email}]]";
        userEmail = $("#email").val();
        userId = $("#id").val();
        csrfValue = $("input[name='_csrf']").val();
        params = {id: userId, email: userEmail, _csrf: csrfValue};
        <!--和UserRestController: checkDuplicateEmail链接 -->
        $.post(url, params, function (response) {
            if (response == "OK") {
                form.submit(); <!--传到@{/users/save}-->
            } else if (response == "Duplicated") {
                showModalDialog("Warning", "There is another user having the email " + userEmail);
            } else {
                showModalDialog("Error", "Unknown response from server");
            }
        }).fail(function () {
            showModalDialog("Error", "Could not connect to the server");
        });

        return false;
    }

    function showModalDialog(title, message) {
        <!-- class="modal-title" id="modalTitle" -->
        $("#modalTitle").text(title); <!--link with corresponding bootstrap -->
        $("#modalBody").text(message);
        $("#modalDialog").modal();
    }

</script>
</body>
</html>